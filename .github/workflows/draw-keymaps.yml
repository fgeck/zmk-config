name: Draw ZMK keymaps

on:
  workflow_dispatch:
  push:
    paths:
      - "config/*.keymap"
      - "config/*.dtsi"
      - "keymap_drawer.config.yaml"
      - "scripts/filter-keymap-for-flake-m.py"
      - "docs/keymap-drawer/anywhy_flake_m.json"

permissions:
  contents: write

jobs:
  draw:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || !contains(github.event.head_commit.message, '[skip ci]')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: pip install keymap-drawer pyyaml

      - name: Generate keymap SVG
        run: |
          keymap -c keymap_drawer.config.yaml parse -z config/anywhy_flake.keymap \
            | python scripts/filter-keymap-for-flake-m.py \
            | keymap -c keymap_drawer.config.yaml draw - -o docs/keymap-drawer/keymap.svg

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update keymap-drawer render"
          file_pattern: "docs/keymap-drawer/keymap.svg"
